version: "3.8"

x-node-common: &node-common
  build:
    context: .
    dockerfile: docker/Dockerfile
  restart: unless-stopped
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8080/node/status"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 120s
  networks:
    - squad-network

services:
  observer-shard-0:
    <<: *node-common
    container_name: mvx-observer-shard-0
    volumes:
      - type: bind
        source: ./data/shard-0/db
        target: /go/mx-chain-go/cmd/node/db
        is_directory: true
      - type: bind
        source: ./data/shard-0/logs
        target: /go/mx-chain-go/cmd/node/logs
        is_directory: true
    command:
      - --destination-shard-as-observer=0
      - --log-level=*:INFO
      - --log-save
      - --display-name=Observer-Shard-0
    networks:
      squad-network:
        ipv4_address: 10.0.0.6

  observer-shard-1:
    <<: *node-common
    container_name: mvx-observer-shard-1
    volumes:
      - type: bind
        source: ./data/shard-1/db
        target: /go/mx-chain-go/cmd/node/db
        is_directory: true
      - type: bind
        source: ./data/shard-1/logs
        target: /go/mx-chain-go/cmd/node/logs
        is_directory: true
    command:
      - --destination-shard-as-observer=1
      - --log-level=*:INFO
      - --log-save
      - --display-name=Observer-Shard-1
    networks:
      squad-network:
        ipv4_address: 10.0.0.5

  observer-shard-2:
    <<: *node-common
    container_name: mvx-observer-shard-2
    volumes:
      - type: bind
        source: ./data/shard-2/db
        target: /go/mx-chain-go/cmd/node/db
        is_directory: true
      - type: bind
        source: ./data/shard-2/logs
        target: /go/mx-chain-go/cmd/node/logs
        is_directory: true
    command:
      - --destination-shard-as-observer=2
      - --log-level=*:INFO
      - --log-save
      - --display-name=Observer-Shard-2
    networks:
      squad-network:
        ipv4_address: 10.0.0.4

  observer-metachain:
    <<: *node-common
    container_name: mvx-observer-metachain
    volumes:
      - type: bind
        source: ./data/metachain/db
        target: /go/mx-chain-go/cmd/node/db
        is_directory: true
      - type: bind
        source: ./data/metachain/logs
        target: /go/mx-chain-go/cmd/node/logs
        is_directory: true
    command:
      - --destination-shard-as-observer=metachain
      - --log-level=*:INFO
      - --log-save
      - --display-name=Observer-Metachain
    networks:
      squad-network:
        ipv4_address: 10.0.0.3

  proxy:
    build:
      context: .
      dockerfile: docker/Dockerfile.proxy
    container_name: mvx-squad-proxy
    restart: unless-stopped
    ports:
      - "8079:8079"
    depends_on:
      - observer-shard-0
      - observer-shard-1
      - observer-shard-2
      - observer-metachain
    networks:
      squad-network:
        ipv4_address: 10.0.0.2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8079/network/config"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  squad-network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.0.0.0/24
