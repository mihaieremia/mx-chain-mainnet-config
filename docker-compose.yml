version: "3.8"

x-node-common: &node-common
  build:
    context: .
    dockerfile: docker/Dockerfile
  restart: unless-stopped
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8080/node/status"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 120s
  networks:
    - squad-network

services:
  observer-shard-0:
    <<: *node-common
    container_name: mvx-observer-shard-0
    volumes:
      - fresh-shard-0-db:/go/mx-chain-go/cmd/node/db
      - fresh-shard-0-logs:/go/mx-chain-go/cmd/node/logs
    command:
      - --working-directory=/go/mx-chain-go/cmd/node
      - --start-in-epoch=true
      - --destination-shard-as-observer=0
      - --log-level=*:INFO
      - --log-save
      - --log-logger-name
      - --log-correlation
      - --display-name=Observer-Shard-0

  observer-shard-1:
    <<: *node-common
    container_name: mvx-observer-shard-1
    volumes:
      - fresh-shard-1-db:/go/mx-chain-go/cmd/node/db
      - fresh-shard-1-logs:/go/mx-chain-go/cmd/node/logs
    command:
      - --working-directory=/go/mx-chain-go/cmd/node
      - --start-in-epoch=true
      - --destination-shard-as-observer=1
      - --log-level=*:INFO
      - --log-save
      - --log-logger-name
      - --log-correlation
      - --display-name=Observer-Shard-1

  observer-shard-2:
    <<: *node-common
    container_name: mvx-observer-shard-2
    volumes:
      - fresh-shard-2-db:/go/mx-chain-go/cmd/node/db
      - fresh-shard-2-logs:/go/mx-chain-go/cmd/node/logs
    command:
      - --working-directory=/go/mx-chain-go/cmd/node
      - --start-in-epoch=true
      - --destination-shard-as-observer=2
      - --log-level=*:INFO
      - --log-save
      - --log-logger-name
      - --log-correlation
      - --display-name=Observer-Shard-2

  observer-metachain:
    <<: *node-common
    container_name: mvx-observer-metachain
    volumes:
      - fresh-metachain-db:/go/mx-chain-go/cmd/node/db
      - fresh-metachain-logs:/go/mx-chain-go/cmd/node/logs
    command:
      - --working-directory=/go/mx-chain-go/cmd/node
      - --start-in-epoch=true
      - --destination-shard-as-observer=metachain
      - --log-level=*:INFO
      - --log-save
      - --log-logger-name
      - --log-correlation
      - --display-name=Observer-Metachain

  proxy:
    build:
      context: .
      dockerfile: docker/Dockerfile.proxy
    container_name: mvx-squad-proxy
    restart: unless-stopped
    ports:
      - "8079:8079"
    depends_on:
      - observer-shard-0
      - observer-shard-1
      - observer-shard-2
      - observer-metachain
    networks:
      - squad-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8079/network/config"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  fresh-shard-0-db:
  fresh-shard-0-logs:
  fresh-shard-1-db:
  fresh-shard-1-logs:
  fresh-shard-2-db:
  fresh-shard-2-logs:
  fresh-metachain-db:
  fresh-metachain-logs:

networks:
  squad-network:
    driver: bridge
